<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泌尿系統自動診斷機</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Tone.js CDN for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* === 模擬地面與機器主體樣式 (保持一致) === */
        body {
            font-family: 'Inter', sans-serif;
            /* 模擬水泥地面或工業地板的深灰色背景 */
            background-color: #3f4a56; 
            background-image: linear-gradient(145deg, #3f4a56 0%, #2f3840 100%);
            display: flex;
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            min-height: 100vh;
            padding: 2rem 0;
            overflow-y: auto;
        }
        .vending-machine {
            max-width: 400px;
            width: 95%;
            margin: 0 auto; 
            border-radius: 1.5rem 1.5rem 0 0; 
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.8), 0 0 0 8px #5c6773; 
            background-image: linear-gradient(to bottom, #4b5563, #1f2937); /* 深灰色金屬漸變 */
            border: 4px solid #7c8896;
            border-bottom: none; 
        }

        /* === 機器腳部樣式 (更新為傾斜工業腳) === */
        .machine-base {
            max-width: 400px;
            width: 95%;
            margin: 0 auto 2rem auto; 
            padding: 0 1.5rem; /* 增加左右邊距來定位腳 */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
            background-color: #2f3840; /* 機身和腳部的連接色 */
            border: 4px solid #7c8896;
            border-top: none; 
            border-radius: 0 0 1.5rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            padding-bottom: 0.5rem; /* 底部內邊距 */
        }

        /* 新增：腳部支撐結構的視覺效果 */
        .machine-foot-angled-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            height: 3.5rem; /* 確保容器高度 */
        }
        
        .machine-foot-angled {
            width: 35%; 
            height: 100%;
            background-color: #5c6773; 
            border: 3px solid #7c8896;
            border-top: none;
            /* 關鍵：使用 skewX 變形來創建傾斜的支撐感 */
            transform: skewX(-5deg); 
            transform-origin: bottom center;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.5), 5px 5px 10px rgba(0, 0, 0, 0.5);
            background-image: linear-gradient(180deg, #4b5563 0%, #5c6773 100%);
            border-radius: 0.25rem;
        }

        /* 讓右腳傾斜方向相反 */
        .machine-foot-angled:last-child {
            transform: skewX(5deg);
        }
        
        /* === 投幣口專屬樣式 (保持一致) === */
        .coin-slot-container {
            background-image: linear-gradient(to bottom, #a0aec0, #718096); 
            padding: 0.5rem;
            border-radius: 9999px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6), 0 4px 6px rgba(0, 0, 0, 0.3); 
            transition: transform 0.1s ease;
        }
        .coin-slot-opening {
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            background-color: #374151;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 1), 0 1px 0 rgba(255, 255, 255, 0.2); 
            cursor: pointer;
        }
        .coin-slot-container:active {
            transform: scale(0.95);
        }
        
        /* === 保持原有泌尿科介面樣式 (保持一致) === */
        .vending-display {
            border: 5px solid #00c7e5; 
            box-shadow: inset 0 0 10px #00c7e5, 0 0 15px #00c7e5; 
        }
        .item-button {
            transition: transform 0.1s, box-shadow 0.1s;
            background-image: linear-gradient(135deg, #2a3c5a 0%, #1f2d42 100%);
            word-break: normal; 
            overflow-wrap: break-word; 
            hyphens: manual; 
        }
        .item-button:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        .item-button:active:not(:disabled) {
            transform: translateY(0);
        }
        .item-button:disabled {
            opacity: 0.4; 
            cursor: not-allowed;
        }
        .selected {
            border: 3px solid #facc15; 
            box-shadow: 0 0 10px #facc15;
            background-image: linear-gradient(135deg, #facc15 0%, #eab308 100%);
            color: #1f2d42; 
            word-break: normal;
            overflow-wrap: break-word;
            hyphens: manual;
        }
        .result-card-slot {
            background-color: #1f2d42;
            padding: 1rem; 
            border-radius: 0 0 0.75rem 0.75rem; 
            position: relative;
            min-height: 6rem; 
            overflow: hidden; 
        }
        .red-divider {
            height: 8px; 
            background-color: #ff0000; 
            width: 100%;
            box-shadow: 0 0 5px #ff0000, 0 0 15px rgba(255, 0, 0, 0.8); 
            transition: box-shadow 0.3s;
        }
        @keyframes printOut {
            0% {
                transform: translateY(-100%); 
                opacity: 0.2;
            }
            100% {
                transform: translateY(0); 
                opacity: 1;
            }
        }
        .print-animation {
            animation: printOut 1.5s ease-out forwards;
            position: relative; 
        }
        @keyframes neon-flash-red {
            0%, 100% {
                box-shadow: 0 0 5px #ff0000, 0 0 15px rgba(255, 0, 0, 0.8);
            }
            50% {
                box-shadow: 0 0 2px #ff0000, 0 0 8px rgba(255, 0, 0, 0.4);
            }
        }
        .flashing-neon-divider {
            animation: neon-flash-red 0.5s infinite alternate;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen">

    <div id="vendingMachine" class="vending-machine w-full max-w-lg rounded-xl overflow-hidden p-4 sm:p-6 text-white border-8 border-gray-900">
        
        <!-- 頂部標題和說明 -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6 tracking-wider text-[#00c7e5]">
            <span class="block">泌尿系統診斷機</span> 
            <!-- START: 軟體版本編號 -->
            <span class="text-base font-normal text-gray-400 block mt-1 text-center">URO Kiosk Unit-v1（2025.9.28 e43581y26y)</span>
            <!-- END: 軟體版本編號 -->
        </h1>
        
        <!-- 顯示螢幕 -->
        <div id="display" class="vending-display p-4 h-28 sm:h-36 mb-6 rounded-lg text-xl sm:text-2xl font-mono text-[#00c7e5] flex flex-col justify-center items-center text-center bg-[#101c30]">
            <p id="instructionText" class="animate-pulse">請投幣啟動服務...</p>
            <p id="selectionText" class="text-base text-gray-400 mt-1"></p>
        </div>

        <!-- === 投幣區 === -->
        <div class="mb-6 p-4 rounded-xl bg-gray-800 border-2 border-gray-700 shadow-inner flex justify-center items-center space-x-6">
            <div class="flex-shrink-0 text-center">
                <p class="text-sm font-semibold text-gray-300 mb-1">投幣口 (點擊啟動)</p>
                <div id="coinSlot" class="coin-slot-container w-20 h-16 cursor-pointer" title="點擊模擬投入硬幣">
                    <div class="coin-slot-opening"></div>
                </div>
            </div>
            <!-- START: 更新服務性質描述 -->
            <div id="coinMessage" class="text-sm text-[#00c7e5] font-bold text-center">
                本診斷機為服務性質。
            </div>
            <!-- END: 更新服務性質描述 -->
        </div>
        <!-- === 投幣區結束 === -->

        <!-- 物品/選項選擇區域 (性別/症狀選擇) -->
        <div id="optionsGrid" class="grid grid-cols-2 gap-4 mb-6">
            <!-- 選項將由 JS 動態生成 -->
        </div>
        
        <!-- 結果/控制面板 -->
        <div class="p-4 rounded-lg bg-[#101c30] border border-gray-700">
            <h2 class="text-xl font-bold text-center mb-3 text-gray-300">控制面板</h2>
            <div class="flex justify-around space-x-4">
                <button id="confirmButton" class="w-full p-3 font-bold rounded-xl text-lg bg-yellow-500 hover:bg-yellow-600 text-gray-900 transition duration-150 disabled:opacity-50" disabled>
                    確認選擇 (✓)
                </button>
                <button id="backButton" class="w-full p-3 font-bold rounded-xl text-lg bg-blue-600 hover:bg-blue-700 transition duration-150 hidden" disabled>
                    返回上層 (←)
                </button>
                <button id="resetButton" class="w-full p-3 font-bold rounded-xl text-lg bg-red-600 hover:bg-red-700 transition duration-150">
                    重新開始 (⟲)
                </button>
            </div>
        </div>

        <!-- 診斷卡出口槽 -->
        <div class="mt-4">
            <!-- 紅粗線：用於分隔控制面板和出口槽，並進行霓虹閃爍 -->
            <div id="redDivider" class="red-divider"></div>

            <!-- 出口槽容器 -->
            <div id="resultCardSlot" class="result-card-slot">
                <p class="text-sm text-gray-500 mb-2">健康建議卡出口 (請在此領取):</p>
                <!-- 確保初始狀態是 hidden -->
                <div id="resultCard" class="hidden bg-gray-100 p-4 rounded-lg text-gray-900 shadow-xl"> 
                    <h3 class="text-xl font-bold text-blue-600 mb-2">診斷卡已發放</h3>
                    <p id="cardTitle" class="font-semibold text-lg"></p>
                    <!-- 確保使用 DIV 容器以容納複雜的 HTML 內容 -->
                    <div id="cardContent" class="text-sm mt-2"></div> 
                    <p class="text-xs text-red-600 mt-3 font-bold">※ 緊急免責聲明：本卡不具醫療診斷效力，請務必諮詢泌尿科醫師。</p>
                </div>
            </div>
        </div>

    </div> <!-- End of .vending-machine -->

    <!-- 機器底部與腳部 (更新) -->
    <div class="machine-base w-full max-w-lg mx-auto">
        <div class="machine-foot-angled-container">
            <div class="machine-foot-angled ml-4"></div>
            <div class="machine-foot-angled mr-4"></div>
        </div>
    </div>
    <!-- 機器底部與腳部結束 -->

    <script>
        // 設定全域變數
        const instructionText = document.getElementById('instructionText');
        const selectionText = document.getElementById('selectionText');
        const optionsGrid = document.getElementById('optionsGrid');
        const confirmButton = document.getElementById('confirmButton');
        const backButton = document.getElementById('backButton');
        const resetButton = document.getElementById('resetButton');
        const redDivider = document.getElementById('redDivider'); 
        const resultCard = document.getElementById('resultCard');
        const cardTitle = document.getElementById('cardTitle');
        const cardContent = document.getElementById('cardContent');
        const coinSlot = document.getElementById('coinSlot');
        const coinMessage = document.getElementById('coinMessage');

        // 核心狀態變數
        let gameState = 'GENDER'; 
        let isServiceActive = false; // 新增：控制服務是否啟動
        let selectedGender = null;
        let selectedCategory = null; 
        let selectedSymptom = null;
        let selectedSubsymptoms = [];
        let neonTimeout = null; 
        
        // Tone.js Synth 初始化
        let synth = null; 
        let coinSoundSynth = null; 

        // --- 音效生成邏輯 ---
        function playPrintSound() {
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {_generatePrintSound();}).catch(err => {console.error("Failed to start Tone.js AudioContext:", err);});
            } else {_generatePrintSound();}
        }

        function _generatePrintSound() {
            if (!synth) {
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "square" }, 
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.3 }
                }).toDestination();
            }
            const volume = 0.5;
            const now = Tone.now();
            const duration = "8n";
            synth.triggerAttackRelease("C4", duration, now, volume); 
            synth.triggerAttackRelease("D4", duration, now + 0.2, volume); 
        }

        function playCoinSound() {
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {_generateCoinSound();}).catch(err => {console.error("Failed to start Tone.js AudioContext for coin sound:", err);});
            } else {_generateCoinSound();}
        }

        function _generateCoinSound() {
            if (!coinSoundSynth) {
                coinSoundSynth = new Tone.NoiseSynth({
                    noise: { type: "white" },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0.0, release: 0.15 }
                }).toDestination();
            }
            const now = Tone.now();
            coinSoundSynth.triggerAttackRelease("16n", now);
        }
        
        // --- 投幣口事件：模擬投入硬幣/啟動服務 ---
        coinSlot.addEventListener('click', () => {
            if (isServiceActive) {
                 coinMessage.textContent = "服務已啟動，請選擇性別！";
                 return;
            }

            playCoinSound();
            isServiceActive = true; 
            
            // 啟用性別選擇按鈕
            document.querySelectorAll('.gender-button').forEach(btn => btn.disabled = false);
            backButton.disabled = false;
            
            // 顯示啟動確認訊息
            coinMessage.textContent = "硬幣投入成功！服務已準備就緒。";
            updateDisplay('泌醫關心您。歡迎使用，請選擇您的性別...');
            
            setTimeout(() => {
                // 將訊息改回服務性質
                coinMessage.textContent = "本診斷機為服務性質。";
            }, 2000);
        });


        // 模擬數據庫 (保持不變)
        const data = {
            '排尿異常（Urinary Dysfunction）': {
                icon: '💧',
                symptoms: {
                    '頻尿/夜尿（Frequency/Nocturia）': {
                        description: '常見於攝護腺肥大、膀胱過動症、神經性膀胱等。建議減少刺激性飲料及睡前飲水，並進行排尿訓練。',
                        subsymptoms: {
                            '日間頻尿（Daytime Frequency）': '可能與咖啡因或液體攝取過多相關。建議監測每日飲水量。',
                            '夜間多尿（Nocturia）': '可能與心臟或腎臟問題相關。若超過2次/夜，需檢查血糖及心功能。',
                            '伴隨急尿（With Urgency）': '暗示膀胱過動症。考慮抗膽鹼藥物治療。'
                        }
                    },
                    '排尿疼痛（Dysuria）': {
                        description: '排尿時伴隨灼熱、刺痛或不適感。最常見於泌尿道感染（UTI）或膀胱炎，但結石或攝護腺炎亦可能引起。需進行尿液常規檢查。',
                        subsymptoms: {
                            '灼熱感（Burning Sensation）': '高度提示尿道或膀胱刺激，常見於膀胱炎。',
                            '刺痛感（Stabbing Pain）': '可能與結石或尿道炎症相關。',
                            '排尿後疼痛（Pain after Voiding）': '多與膀胱痙攣相關，見於間質性膀胱炎。',
                            '尿道口疼痛（Meatal Pain）': '提示尿道炎或龜頭炎。'
                        }
                    },
                    '尿急/急迫性尿失禁（Urgency/Urge Incontinence）': {
                        description: '常見於膀胱過動症、神經性膀胱等。建議進行骨盆底肌訓練（凱格爾運動）。',
                        subsymptoms: {
                            '突然強烈尿意（Sudden Urge）': '可能與感染或神經問題相關。需尿培養檢查。',
                            '漏尿發生（Leakage）': '區分急迫性失禁。考慮藥物治療。',
                            '頻繁發作（Frequent Episodes）': '記錄日誌，尋求泌尿科協助。'
                        }
                    },
                    '排尿困難（Voiding Difficulty）': {
                        description: '表現為解尿費力、尿流變細、遲緩、斷續、餘尿感。常見於攝護腺肥大、尿道狹窄。需流量檢查。',
                        subsymptoms: {
                            '起始延遲（Hesitancy）': '常見於前列腺肥大。建議alpha阻斷劑。',
                            '尿流中斷（Intermittency）': '可能尿道狹窄。需影像學檢查。',
                            '餘尿感（Post-void Dribbling）': '暗示膀胱頸問題。進行殘尿量測量。'
                        }
                    },
                }
            },
            '尿液異常（Urine Abnormalities）': {
                icon: '🩸',
                symptoms: {
                    '血尿（Hematuria）': {
                        description: '包括顯微血尿、肉眼血尿。需警覺感染、結石、腫瘤。尤其年長者，需立即排除惡性腫瘤。',
                        subsymptoms: {
                            '肉眼血尿（Gross Hematuria）': '無論是否疼痛，都是嚴重徵兆。請在24小時內看泌尿科。',
                            '顯微血尿（Microscopic Hematuria）': '通常健康檢查發現。若合併蛋白尿，需檢查腎臟病變。',
                            '間歇性（Intermittent）': '檢查凝血功能或影像學。'
                        }
                    },
                    '膿尿/尿液混濁或異味（Pyuria/Cloudy or Odorous Urine）': {
                        description: '多數與感染或脫水有關。若伴隨發燒，應儘快進行尿液分析及細菌培養。',
                        subsymptoms: {
                            '伴隨發燒（With Fever）': '高度懷疑UTI。立即抗生素治療。',
                            '脫水相關（Dehydration-related）': '增加飲水，避免高蛋白飲食。',
                            '異味強烈（Strong Odor）': '可能細菌感染。尿培養檢查。'
                        }
                    },
                    '尿液帶泡（Foamy Urine）': {
                        description: '提示蛋白尿，可能系統性疾病如腎臟病。需血液及24小時尿液檢查評估腎功能。',
                        subsymptoms: {
                            '持續不散（Persistent）': '暗示大量蛋白尿。檢查糖尿病或高血壓。',
                            '合併水腫（With Edema）': '腎病症候群。腎功能檢查。',
                            '家族史（Familial）': '考慮遺傳性腎病。'
                        }
                    },
                }
            },
            '疼痛相關（Pain-Related）': {
                icon: '⚠️',
                symptoms: {
                    '腰痛/肋脊角痛（Flank Pain/Costovertebral Angle Tenderness）': {
                        description: '常見於腎盂腎炎、腎結石。有時為急症，需快速判斷。',
                        subsymptoms: {
                            '劇痛突發（Severe Sudden Pain）': '強烈懷疑腎絞痛。立即掛急診。',
                            '伴隨發燒（With Fever）': '排除腎盂腎炎。抗生素治療。',
                            '反覆發作（Recurrent）': '檢查結石代謝異常。'
                        }
                    },
                    '下腹痛/會陰痛（Suprapubic/Perineal Pain）': {
                        description: '常見於膀胱炎、攝護腺炎。建議記錄疼痛日誌，尋求疼痛科/泌尿科協助。',
                        subsymptoms: {
                            '排尿時加劇（Worsens with Urination）': '可能膀胱炎。尿培養。',
                            '慢性疼痛（Chronic）': '男性考慮慢性前列腺炎；女性排除間質性膀胱炎。',
                            '局部腫脹（Localized Swelling）': '檢查感染或阻塞。'
                        }
                    },
                    '睪丸痛/陰囊腫脹（Testicular Pain/Scrotal Swelling）': {
                        description: '常見於副睪炎、睪丸扭轉。需快速判斷，可能為急症。',
                        isMaleOnly: true, 
                        subsymptoms: {
                            '突發劇痛（Sudden Severe Pain）': '懷疑睪丸扭轉。立即手術。',
                            '伴隨發燒（With Fever）': '副睪炎。抗生素治療。',
                            '腫脹明顯（Obvious Swelling）': '超音波檢查排除腫瘤。'
                        }
                    },
                    '全身性發燒/寒顫（Systemic Fever/Chills）': {
                        description: '全身性發燒（>38°C）或畏寒。在泌尿系統中，這高度暗示存在急性感染，如腎盂腎炎、急性前列腺炎或副睪炎。必須立即就醫。',
                        subsymptoms: {
                            '高燒持續（Sustained High Fever）': '立即急診檢查血常規及尿液，排除敗血症。',
                            '伴隨畏寒/發抖（With Chills/Rigors）': '提示菌血症風險高，建議靜脈抗生素治療。',
                            '無其他泌尿症狀（No Other Urinary Symptoms）': '需排除非泌尿系統感染，如流感或新冠肺炎。'
                        }
                    },
                }
            },
            '生殖道與性健康（Genital & Sexual Health）': {
                icon: '🦠', 
                symptoms: {
                    // *** 男性專屬症狀 ***
                    '尿道分泌物（Urethral Discharge）': {
                        description: '常見於性傳播感染（如淋病、衣原體等）或尿道炎，需進行尿道或分泌物培養檢查以確定病原體。請告知醫師是否有不安全性行為史。',
                        isMaleOnly: true, 
                        subsymptoms: {
                            '黃/綠色濃稠分泌物（Thick Yellow/Green Discharge）': '高度懷疑淋病性尿道炎（Gonococcal Urethritis）。需立即抗生素治療及追蹤。',
                            '白色清澈稀薄分泌物（Clear Thin White Discharge）': '常見於非淋病性尿道炎（Non-Gonococcal Urethritis, NGU），如衣原體感染。',
                            '伴隨發癢或灼熱（With Itching or Burning）': '可能為單純皰疹或其他病毒感染。',
                            '僅清晨分泌物（Morning Discharge Only）': '常見於NGU。建議進行核酸檢測（NAAT）。',
                        }
                    },
                    '勃起功能障礙/早洩（Erectile Dysfunction/Premature Ejaculation）': {
                        description: '涉及泌尿與生殖功能，影響生活品質。可能與攝護腺問題或血管疾病相關。',
                        isMaleOnly: true, 
                        subsymptoms: {
                            '持續性障礙（Persistent ED）': '檢查心血管風險。考慮PDE5抑制劑。',
                            '心理因素（Psychogenic）': '壓力相關。心理諮詢。',
                            '伴隨其他症狀（With Other Symptoms）': '如糖尿病。綜合評估。'
                        }
                    },
                    '血精症（Hemospermia）': {
                        description: '血精症。需排除感染、腫瘤或外傷。影響生育。',
                        isMaleOnly: true, 
                        subsymptoms: {
                            '單次發生（Single Episode）': '通常良性。觀察。',
                            '反覆（Recurrent）': '前列腺檢查或超音波。',
                            '伴隨疼痛（With Pain）': '可能感染。抗生素。'
                        }
                    },
                    '男性不孕症（Male Infertility）': {
                        description: '少精症、無精症伴隨泌尿系異常。影響生育，需精液分析。',
                        isMaleOnly: true, 
                        subsymptoms: {
                            '少精症（Oligospermia）': '檢查荷爾蒙或遺傳。',
                            '無精症（Azoospermia）': '排除阻塞或睪丸問題。手術評估。',
                            '伴隨泌尿症狀（With Urological Symptoms）': '如攝護腺肥大。綜合治療。'
                        }
                    },
                    // *** 女性專屬症狀 ***
                    '陰道分泌物異常（Abnormal Vaginal Discharge）': {
                        description: '包括顏色、氣味、量的變化，常與陰道炎（細菌、黴菌）、子宮頸炎或骨盆腔感染相關。泌尿科主要鑑別是否為泌尿道感染併發。',
                        isFemaleOnly: true, 
                        subsymptoms: {
                            '豆腐渣樣分泌物（Curd-like Discharge）': '高度提示黴菌感染（念珠菌）。局部抗黴菌藥膏。',
                            '魚腥味（Fishy Odor）': '提示細菌性陰道病。口服或局部抗生素。',
                            '黃色或綠色分泌物（Yellow or Green Discharge）': '需排除滴蟲或淋病感染。建議婦科或性病檢查。',
                            '合併腹痛（With Abdominal Pain）': '需排除骨盆腔發炎（PID）。立即就醫。'
                        }
                    },
                    '外陰/陰道疼痛或發癢（Vulvar/Vaginal Pain or Itching）': {
                        description: '常見於黴菌感染、接觸性皮膚炎、外陰炎或巴氏腺囊腫。若合併排尿痛，可能為泌尿道感染（UTI）連帶刺激。',
                        isFemaleOnly: true, 
                        subsymptoms: {
                            '發癢劇烈（Severe Itching）': '提示黴菌感染或濕疹。',
                            '灼熱感（Burning Sensation）': '可能接觸性過敏或細菌感染。',
                            '局部腫塊（Localized Lump）': '檢查是否為巴氏腺膿瘍或囊腫。',
                            '乾燥與萎縮（Dryness and Atrophy）': '與更年期荷爾蒙相關，考慮局部雌激素。'
                        }
                    },
                    '性交疼痛（Dyspareunia）': {
                        description: '性行為時感到疼痛。分為淺層（陰道口）與深層（子宮頸）。可能與UTI、陰道炎、子宮內膜異位、或間質性膀胱炎相關。',
                        isFemaleOnly: true, 
                        subsymptoms: {
                            '淺層疼痛（Superficial Pain）': '可能陰道痙攣或外陰炎。局部止痛與物理治療。',
                            '深層疼痛（Deep Pain）': '需排除子宮內膜異位或骨盆腔沾黏。建議婦科超音波。',
                            '排尿後疼痛（Pain after Intercourse）': '可能為性行為引起的泌尿道刺激。多飲水。'
                        }
                    },
                    '慢性骨盆腔疼痛（Chronic Pelvic Pain）': {
                        description: '持續超過六個月、非週期性的下腹部疼痛。這是一個複雜的診斷，涉及泌尿、婦科、消化系統，常見於間質性膀胱炎、慢性盆腔炎症候群。',
                        isFemaleOnly: true, 
                        subsymptoms: {
                            '疼痛位置不確定（Vague Pain Location）': '需綜合評估。考慮神經性疼痛。',
                            '排尿/膀胱脹滿時加重（Worsens with Bladder Fullness）': '高度懷疑間質性膀胱炎。建議膀胱鏡檢查。',
                            '合併經痛（Combined with Dysmenorrhea）': '需排除子宮內膜異位症。',
                            '影響日常生活（Affecting Daily Life）': '多科會診，如疼痛科。'
                        }
                    },
                }
            }
        };

        const GENDER_OPTIONS = {
            '男性 (♂)': 'MALE',
            '女性 (♀)': 'FEMALE'
        };

        
        /**
         * 根據性別過濾特定類別下的症狀
         * @param {string} categoryName 
         * @returns {object} 過濾後的症狀物件
         */
        function getFilteredSymptoms(categoryName) {
            const symptoms = JSON.parse(JSON.stringify(data[categoryName].symptoms)); 
            
            for (const symptomName in symptoms) {
                const symptomData = symptoms[symptomName];

                if (selectedGender === 'FEMALE') {
                    if (symptomData.isMaleOnly || symptomName === '睪丸痛/陰囊腫脹（Testicular Pain/Scrotal Swelling）') {
                        delete symptoms[symptomName];
                    }
                } else if (selectedGender === 'MALE') {
                    if (symptomData.isFemaleOnly) {
                        delete symptoms[symptomName];
                    }
                }
            }
            return symptoms;
        }

        /**
         * 根據性別替換建議中的專屬名詞
         * @param {string} adviceText - 原始建議文字
         * @param {string} gender - 'MALE' or 'FEMALE'
         * @returns {string} 替換後的文字
         */
        function getGenderSpecificAdvice(adviceText, gender) {
            if (gender === 'FEMALE') {
                let text = adviceText;
                text = text.replace(/攝護腺肥大/g, '膀胱頸阻塞/增厚');
                text = text.replace(/前列腺炎/g, '間質性膀胱炎/慢性骨盆疼痛綜合症');
                text = text.replace(/急性前列腺炎/g, '嚴重泌尿道感染/腎盂腎炎');
                text = text.replace(/男性考慮慢性前列腺炎；女性排除間質性膀胱炎/g, '需排除間質性膀胱炎/慢性骨盆疼痛綜合症');
                text = text.replace(/尿道炎或龜頭炎/g, '尿道炎或生殖器炎症');
                text = text.replace(/副睪炎/g, '生殖系統炎症');
                return text;
            }
            return adviceText; 
        }

        /**
         * 更新顯示螢幕上的文字和狀態
         * @param {string} instruction 
         * @param {string} selection 
         */
        function updateDisplay(instruction, selection = '') {
            instructionText.textContent = instruction;
            selectionText.textContent = selection;
        }

        /**
         * 渲染可選的按鈕列表
         */
        function renderOptions(optionsMap, type) {
            optionsGrid.innerHTML = '';
            
            const keys = Object.keys(optionsMap);
            const cols = (type === 'gender' || type === 'category') ? 2 : (keys.length > 2 ? 2 : 1);
            optionsGrid.className = `grid grid-cols-${cols} sm:grid-cols-2 gap-4 mb-6`;
            
            keys.forEach(key => {
                const option = optionsMap[key];
                const button = document.createElement('button');
                const buttonText = type === 'category' ? `${option.icon} ${key}` : key;
                button.textContent = buttonText.replace(/（[^）]+）/g, ''); 
                
                button.dataset.value = (type === 'gender') ? option : key; 
                
                button.classList.add(
                    'item-button', 
                    'p-4', 
                    'rounded-xl', 
                    'text-base', 
                    'sm:text-lg', 
                    'font-bold', 
                    'text-gray-200',
                    'shadow-lg',
                    'border-2',
                    'border-gray-700',
                    'break-words'
                );
                
                // 新增：僅在服務啟用且為性別選擇階段時啟用按鈕
                if (type === 'gender' && !isServiceActive) {
                    button.disabled = true;
                    button.classList.add('gender-button'); // 添加標記 class
                }

                if (type === 'gender' && selectedGender === button.dataset.value) {
                    button.classList.add('selected', 'text-gray-900');
                    button.classList.remove('item-button', 'text-gray-200');
                } else if (type === 'category' && selectedCategory === key) {
                    button.classList.add('selected', 'text-gray-900');
                    button.classList.remove('item-button', 'text-gray-200');
                } else if (type === 'symptom' && selectedSymptom === key) {
                    button.classList.add('selected', 'text-gray-900');
                    button.classList.remove('item-button', 'text-gray-200');
                } else if (type === 'subsymptom' && selectedSubsymptoms.includes(key)) {
                    button.classList.add('selected', 'text-gray-900');
                    button.classList.remove('item-button', 'text-gray-200');
                }

                button.addEventListener('click', () => {
                    if (type === 'gender') handleGenderSelect(button.dataset.value);
                    else if (type === 'category') handleCategorySelect(key);
                    else if (type === 'symptom') handleSymptomSelect(key);
                    else if (type === 'subsymptom') handleSubsymptomToggle(key, button);
                });
                optionsGrid.appendChild(button);
            });
        }

        function handleGenderSelect(genderValue) {
            selectedGender = genderValue;
            gameState = 'CATEGORY';

            const categories = {};
            for (const key in data) {
                categories[key] = { icon: data[key].icon };
            }

            renderOptions(categories, 'category');
            
            const genderDisplay = genderValue === 'MALE' ? '男性 (♂)' : '女性 (♀)';
            updateDisplay(`請選擇您的主要不適類別...`, `[性別]: ${genderDisplay}`);
            backButton.classList.add('hidden'); 
            confirmButton.disabled = true; 
        }

        function handleCategorySelect(categoryName) {
            selectedCategory = categoryName;
            selectedSymptom = null; 
            selectedSubsymptoms = []; 
            gameState = 'SYMPTOM';
            
            const symptoms = getFilteredSymptoms(categoryName);
            
            renderOptions(symptoms, 'symptom');
            const genderDisplay = selectedGender === 'MALE' ? '男性 (♂)' : '女性 (♀)';
            updateDisplay(`請選擇您的具體症狀:`, `[性別]: ${genderDisplay} | [類別]: ${categoryName}`);
            confirmButton.disabled = true;
            backButton.classList.remove('hidden'); 
            
            resultCard.classList.add('hidden');
            resultCard.style.display = 'none';
            resultCard.classList.remove('print-animation');
            redDivider.classList.remove('flashing-neon-divider'); 
        }

        function handleSymptomSelect(symptomName) {
            selectedSymptom = symptomName;
            selectedSubsymptoms = []; 
            gameState = 'SUBSYMPTOM';
            
            const subsymptoms = data[selectedCategory].symptoms[symptomName].subsymptoms; 
            renderOptions(subsymptoms, 'subsymptom');
            const genderDisplay = selectedGender === 'MALE' ? '男性 (♂)' : '女性 (♀)';
            updateDisplay(`請選擇相關的子症狀 (可多選):`, `[症狀]: ${symptomName} | [性別]: ${genderDisplay}`);
            confirmButton.disabled = true; 
        }

        function handleSubsymptomToggle(subsymptomName, button) {
            const index = selectedSubsymptoms.indexOf(subsymptomName);

            if (index > -1) {
                selectedSubsymptoms.splice(index, 1);
                button.classList.remove('selected', 'text-gray-900');
                button.classList.add('item-button', 'text-gray-200');
            } else {
                selectedSubsymptoms.push(subsymptomName);
                button.classList.add('selected', 'text-gray-900');
                button.classList.remove('item-button', 'text-gray-200');
            }

            const baseInfo = `[症狀]: ${selectedSymptom} | [性別]: ${selectedGender === 'MALE' ? '男性 (♂)' : '女性 (♀)'}`;
            selectionText.textContent = baseInfo + ` | [已選子項目]: ${selectedSubsymptoms.join('、') || '無'}`;
            
            confirmButton.disabled = selectedSubsymptoms.length === 0;
        }

        /**
         * 處理確認按鈕點擊 (進行模擬診斷)
         */
        confirmButton.addEventListener('click', () => {
            if (gameState !== 'SUBSYMPTOM' || selectedSubsymptoms.length === 0) return;

            gameState = 'PROCESSING';
            confirmButton.disabled = true;
            backButton.classList.add('hidden');
            optionsGrid.innerHTML = '';
            
            updateDisplay('████ 掃描與處理中... ████', '系統正在匹配最相關的健康資訊，請稍候...');

            resultCard.classList.add('hidden');
            resultCard.style.display = 'none';
            resultCard.classList.remove('print-animation');
            redDivider.classList.remove('flashing-neon-divider'); 
            
            clearTimeout(neonTimeout); 

            setTimeout(() => {
                simulateDiagnosis();
            }, 3000);
        });

        /**
         * 模擬診斷並顯示結果卡
         */
        function simulateDiagnosis() {
            try {
                gameState = 'RESULT';
                
                if (!selectedCategory || !selectedSymptom || !data[selectedCategory].symptoms[selectedSymptom] || selectedSubsymptoms.length === 0) {
                    throw new Error("診斷數據不足或無效。請重新開始。");
                }

                const symptomData = data[selectedCategory].symptoms[selectedSymptom];
                const subsymptomsMap = symptomData.subsymptoms;
                
                let combinedAdvice = `<ul>`;
                combinedAdvice += selectedSubsymptoms.map(sub => {
                    let advice = subsymptomsMap[sub] || '此子症狀無特定模擬建議。';
                    advice = getGenderSpecificAdvice(advice, selectedGender); 
                    return `<li class="mb-2"><span class="font-extrabold text-blue-900">${sub}</span>: ${advice}</li>`;
                }).join('');
                combinedAdvice += `</ul>`;
                
                const diagnosisTitle = `診斷代碼: URO-${Math.floor(Math.random() * 900) + 100} - 初步專業建議`;
                const genderLabel = selectedGender === 'MALE' ? '男性' : '女性';
                let diagnosisContent = `<p class="font-medium mb-1">您的選擇 [${genderLabel}] 集中在：<span class="text-red-700">${selectedCategory} - ${selectedSymptom}</span>。</p>`;
                
                let mainDescription = getGenderSpecificAdvice(symptomData.description, selectedGender);

                diagnosisContent += `<span class="font-bold text-red-700 block mt-3">【首要建議與鑑別】</span><p class="font-medium mt-1">${mainDescription}</p>`;
                diagnosisContent += `<span class="font-bold text-red-700 block mt-3">【細節症狀與建議】</span><div class="mt-1 text-sm space-y-1">${combinedAdvice}</div>`;
                
                cardTitle.textContent = diagnosisTitle;
                cardContent.innerHTML = diagnosisContent;

                // 1. 播放音效 (兩聲簡短電子音)
                playPrintSound();
                
                // 2. 應用霓虹閃爍效果到紅線
                redDivider.classList.add('flashing-neon-divider');

                // 3. 顯示結果卡並應用出紙動畫 (動畫持續 1.5s)
                resultCard.classList.remove('hidden');
                resultCard.style.display = 'block';
                resultCard.classList.add('print-animation');

                updateDisplay(`建議卡已出爐! 請取走`, `請詳閱建議並儘速就醫。`);
                
                // 4. 定時器：在 5 秒 (5000ms) 後停止霓虹閃爍效果
                neonTimeout = setTimeout(() => {
                    redDivider.classList.remove('flashing-neon-divider');
                    console.log("霓虹閃爍已停止。");
                }, 5000); 

                console.log("診斷完成，結果卡已嘗試顯示。");
                backButton.classList.add('hidden');

            } catch (error) {
                console.error("模擬診斷出錯:", error);
                cardTitle.textContent = "系統錯誤 (Error)";
                cardContent.innerHTML = `<p class="text-red-500 font-bold">無法完成診斷。請點擊「重新開始」按鈕。</p><p class="mt-2 text-xs">技術訊息: ${error.message}</p>`;
                resultCard.classList.remove('hidden');
                resultCard.style.display = 'block';
                resultCard.classList.add('print-animation');
                redDivider.classList.remove('flashing-neon-divider'); 

                updateDisplay(`診斷失敗，請重新嘗試`, `發生錯誤，請查看出口卡訊息。`);
            } finally {
                confirmButton.disabled = true;
            }
        }

        /**
         * 處理返回按鈕點擊
         */
        backButton.addEventListener('click', () => {
            clearTimeout(neonTimeout); 
            if (gameState === 'SUBSYMPTOM') {
                gameState = 'SYMPTOM';
                const symptoms = getFilteredSymptoms(selectedCategory); 
                renderOptions(symptoms, 'symptom');
                const genderDisplay = selectedGender === 'MALE' ? '男性 (♂)' : '女性 (♀)';
                updateDisplay(`請選擇您的具體症狀:`, `[性別]: ${genderDisplay} | [類別]: ${selectedCategory}`);
                selectedSubsymptoms = [];
                confirmButton.disabled = true;
            } else if (gameState === 'SYMPTOM') {
                gameState = 'CATEGORY';
                const categories = {};
                for (const key in data) { categories[key] = { icon: data[key].icon }; }
                renderOptions(categories, 'category');
                const genderDisplay = selectedGender === 'MALE' ? '男性 (♂)' : '女性 (♀)';
                updateDisplay(`請選擇您的主要不適類別:`, `[性別]: ${genderDisplay}`);
                selectedCategory = null;
                selectedSymptom = null;
                confirmButton.disabled = true;
                backButton.classList.add('hidden'); 
            } else if (gameState === 'CATEGORY') {
                resetButton.click(); // 退回至性別選擇
            }
            redDivider.classList.remove('flashing-neon-divider'); 
        });

        /**
         * 處理重新開始按鈕點擊
         */
        resetButton.addEventListener('click', () => {
            clearTimeout(neonTimeout); 
            // 重置所有狀態
            gameState = 'GENDER';
            isServiceActive = false; // 必須重新投幣
            selectedGender = null;
            selectedCategory = null;
            selectedSymptom = null;
            selectedSubsymptoms = []; 
            
            renderOptions(GENDER_OPTIONS, 'gender');
            
            updateDisplay('請投幣啟動服務...');
            
            confirmButton.disabled = true;
            backButton.classList.add('hidden');
            resultCard.classList.add('hidden');
            resultCard.style.display = 'none';
            resultCard.classList.remove('print-animation');
            redDivider.classList.remove('flashing-neon-divider'); 
        });

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', () => {
            resetButton.click(); 
        });

    </script>
</body>
</html>

